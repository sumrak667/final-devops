pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "summmrak/my-appfinal"
        REGISTRY = "https://index.docker.io/v1/"
        DOCKER_CREDENTIALS = "docker-hub-cred-id"
        GIT_CREDENTIALS = "github-cred-id"
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10')) // хранить только последние 10 билдов
        timestamps()
    }
    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']], // всегда main
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/sumrak667/final-devops.git',
                        credentialsId: "${GIT_CREDENTIALS}"
                    ]]
                ])
            }
        }

        stage('Build') {
            steps {
                sh './gradlew clean build'
            }
        }

        stage('Test') {
            steps {
                sh './gradlew test'
            }
        }

        stage('Static Code Analysis') {
            steps {
                // опционально, включить если используешь Checkstyle или SpotBugs
                sh './gradlew check'
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    def versionTag = "${env.BUILD_NUMBER}" // динамический тег
                    docker.withRegistry(REGISTRY, DOCKER_CREDENTIALS) {
                        def app = docker.build("${DOCKER_IMAGE}:${versionTag}")
                        app.push()
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main' // деплой только из main
            }
            steps {
                echo "Deploying application..."
                // тут можно добавить команду деплоя, например ssh или kubectl
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'app/build/libs/*.jar', allowEmptyArchive: true
            junit 'app/build/test-results/test/*.xml'
        }
        success {
            echo 'Build succeeded!'
            // можно добавить уведомления в Slack/Email
        }
        failure {
            echo 'Build failed!'
            // уведомления о падении
        }
    }
}
